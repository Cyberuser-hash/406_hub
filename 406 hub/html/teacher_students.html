<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление студентами - 406 Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f7fa; min-height: 100vh; }
        .header { background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .tabs { display: flex; background: white; border-radius: 10px 10px 0 0; overflow: hidden; }
        .tab { padding: 15px 25px; background: #f8f9fa; border: none; cursor: pointer; font-weight: 600; color: #666; }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .tab-content { background: white; padding: 30px; border-radius: 0 0 10px 10px; margin-bottom: 20px; min-height: 500px; display: none; }
        .tab-content.active { display: block; }
        
        .students-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .student-card { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; transition: all 0.3s ease; }
        .student-card:hover { border-color: #667eea; box-shadow: 0 5px 15px rgba(102,126,234,0.1); }
        .student-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .student-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 600; }
        .student-info { flex: 1; }
        .student-name { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .student-login { color: #666; font-size: 14px; }
        .student-email { color: #888; font-size: 13px; margin-bottom: 8px; }
        .student-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .stat-number { font-size: 18px; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 12px; color: #666; }
        .student-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #e9ecef; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #e9ecef; }
        .data-table tr:hover { background: #f8f9fa; }
        
        .search-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #667eea; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .message.success { background: #d4f4e0; color: #155724; }
        .message.error { background: #fde8e8; color: #721c24; }
        
        .courses-checkbox { max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 6px; padding: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #f8f9fa; }
        .checkbox-item:last-child { border-bottom: none; }
        
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; }
        .status-active { background: #28a745; }
        .status-inactive { background: #6c757d; }
        
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 4px; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading-spinner { font-size: 48px; margin-bottom: 20px; color: #667eea; }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Назад в панель</button>
        <div id="teacherInfo"></div>
    </div>

    <div class="container">
        <div class="action-bar">
            <h1><i class="fas fa-users"></i> Управление студентами</h1>
            <button class="btn btn-success" onclick="showAddStudentModal()">
                <i class="fas fa-user-plus"></i> Добавить студента
            </button>
        </div>

        <div class="search-box">
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                <div class="form-group">
                    <label class="form-label">Поиск студента</label>
                    <input type="text" id="searchStudent" class="form-input" placeholder="Поиск по имени, логину или email..." onkeyup="searchStudents()">
                </div>
                <div class="form-group">
                    <label class="form-label">Фильтр по курсу</label>
                    <select id="courseFilter" class="form-select" onchange="filterStudents()">
                        <option value="">Все курсы</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="loadStudents()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">Все студенты</button>
            <button class="tab" onclick="showTab('assignments')">Назначение курсов</button>
            <button class="tab" onclick="showTab('progress')">Прогресс обучения</button>
        </div>

        <div id="students" class="tab-content active">
            <div id="message" class="message"></div>
            <div class="students-grid" id="studentsGrid">
                <div class="loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <p>Загрузка студентов...</p>
                </div>
            </div>
        </div>

        <div id="assignments" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Назначение курсов студентам</h3>
                <button class="btn btn-primary" onclick="showBulkAssignModal()">
                    <i class="fas fa-tasks"></i> Массовое назначение
                </button>
            </div>
            <div id="assignmentsContent">
                <div class="loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <p>Загрузка данных...</p>
                </div>
            </div>
        </div>

        <div id="progress" class="tab-content">
            <h3>Прогресс студентов по курсам</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Студент</th>
                            <th>Курс</th>
                            <th>Заданий</th>
                            <th>Выполнено</th>
                            <th>Прогресс</th>
                            <th>Средний балл</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="progressTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-spinner fa-spin"></i> Загрузка данных...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления студента -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Добавить нового студента</h3>
                <button class="close-btn" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form id="addStudentForm">
                <div class="form-group">
                    <label class="form-label">Логин *</label>
                    <input type="text" id="newStudentLogin" class="form-input" placeholder="Уникальный логин" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="newStudentEmail" class="form-input" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль *</label>
                    <input type="password" id="newStudentPassword" class="form-input" placeholder="Минимум 6 символов" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Имя</label>
                    <input type="text" id="newStudentFirstName" class="form-input" placeholder="Имя студента">
                </div>
                <div class="form-group">
                    <label class="form-label">Фамилия</label>
                    <input type="text" id="newStudentLastName" class="form-input" placeholder="Фамилия студента">
                </div>
                <div class="form-group">
                    <label class="form-label">Группа</label>
                    <input type="text" id="newStudentGroup" class="form-input" placeholder="Например: ПИ-21-1">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Создать аккаунт</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно назначения курсов -->
    <div id="assignCoursesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Назначить курсы студенту</h3>
                <button class="close-btn" onclick="closeModal('assignCoursesModal')">&times;</button>
            </div>
            <input type="hidden" id="assignStudentId">
            <div class="form-group">
                <label class="form-label">Студент: <span id="assignStudentName" style="font-weight: 600;"></span></label>
            </div>
            <div class="form-group">
                <label class="form-label">Выберите курсы для назначения:</label>
                <div class="courses-checkbox" id="coursesCheckbox">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка курсов...
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="assignCoursesToStudent()">Назначить выбранные курсы</button>
                <button class="btn btn-secondary" onclick="closeModal('assignCoursesModal')">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно массового назначения -->
    <div id="bulkAssignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Массовое назначение курсов</h3>
                <button class="close-btn" onclick="closeModal('bulkAssignModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Выберите курс:</label>
                <select id="bulkCourseSelect" class="form-select">
                    <option value="">Загрузка курсов...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Выберите студентов:</label>
                <div class="courses-checkbox" id="bulkStudentsCheckbox">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка студентов...
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="bulkAssignCourse()">Назначить курс выбранным студентам</button>
                <button class="btn btn-secondary" onclick="closeModal('bulkAssignModal')">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        const teacher = JSON.parse(localStorage.getItem('user'));
        let allStudents = [];
        let allCourses = [];
        let currentStudents = [];

        // Проверка авторизации
        if (!teacher || (teacher.role !== 'teacher' && teacher.role !== 'admin')) {
            window.location.href = 'login.html';
        }

        document.getElementById('teacherInfo').textContent = `${teacher.first_name || teacher.login} (Преподаватель)`;
        
        // Загрузка данных при открытии страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            loadCourseFilter();
            loadProgressData();
        });

        // Функции для вкладок
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Загружаем данные для активной вкладки
            if (tabName === 'progress') {
                loadProgressData();
            } else if (tabName === 'assignments') {
                loadAssignmentsContent();
            }
        }

        // Загрузка студентов
        async function loadStudents() {
            showLoading('studentsGrid', 'Загрузка студентов...');
            
            try {
                const response = await fetch('handlers/teacher_get_students.php');
                const result = await response.json();
                
                if (result.success) {
                    allStudents = result.data;
                    currentStudents = [...allStudents];
                    displayStudents(allStudents);
                } else {
                    showMessage('Ошибка загрузки студентов', 'error');
                    showError('studentsGrid', 'Не удалось загрузить студентов');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showMessage('Ошибка соединения с сервером', 'error');
                showError('studentsGrid', 'Ошибка соединения с сервером');
            }
        }

        // Отображение студентов в виде карточек
        function displayStudents(students) {
            const container = document.getElementById('studentsGrid');
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Студенты не найдены</h3>
                        <p>Добавьте первого студента в систему</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = students.map(student => `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-avatar">
                            ${(student.first_name?.charAt(0) || student.login.charAt(0)).toUpperCase()}
                        </div>
                        <div class="student-info">
                            <div class="student-name">
                                ${student.first_name || 'Не указано'} ${student.last_name || ''}
                            </div>
                            <div class="student-login">@${student.login}</div>
                            <div class="student-email">${student.email}</div>
                            ${student.student_group ? `<div style="color: #667eea; font-size: 12px;">Группа: ${student.student_group}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="student-stats">
                        <div class="stat-item">
                            <div class="stat-number">${student.courses_count || 0}</div>
                            <div class="stat-label">Курсов</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${student.assignments_count || 0}</div>
                            <div class="stat-label">Заданий</div>
                        </div>
                    </div>
                    
                    <div class="student-actions">
                        <button class="btn-small btn-primary" onclick="assignCourses(${student.id}, '${student.first_name || ''} ${student.last_name || ''}')">
                            <i class="fas fa-book"></i> Курсы
                        </button>
                        <button class="btn-small btn-secondary" onclick="viewStudentProgress(${student.id})">
                            <i class="fas fa-chart-line"></i> Прогресс
                        </button>
                        <button class="btn-small btn-danger" onclick="deleteStudent(${student.id})">
                            <i class="fas fa-trash"></i> Удалить
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Поиск студентов
        function searchStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            const filteredStudents = allStudents.filter(student => 
                (student.first_name && student.first_name.toLowerCase().includes(searchTerm)) ||
                (student.last_name && student.last_name.toLowerCase().includes(searchTerm)) ||
                student.login.toLowerCase().includes(searchTerm) ||
                student.email.toLowerCase().includes(searchTerm) ||
                (student.student_group && student.student_group.toLowerCase().includes(searchTerm))
            );
            currentStudents = filteredStudents;
            displayStudents(filteredStudents);
        }

        // Загрузка курсов для фильтра
        async function loadCourseFilter() {
            try {
                const response = await fetch('handlers/teacher_get_courses.php');
                const result = await response.json();
                
                if (result.success) {
                    const filter = document.getElementById('courseFilter');
                    filter.innerHTML = '<option value="">Все курсы</option>' +
                        result.data.map(course => 
                            `<option value="${course.id}">${course.title}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Ошибка загрузки курсов:', error);
            }
        }

        // Фильтрация студентов по курсу
        async function filterStudents() {
            const courseId = document.getElementById('courseFilter').value;
            if (!courseId) {
                currentStudents = [...allStudents];
                displayStudents(allStudents);
                return;
            }
            
            try {
                const response = await fetch(`handlers/teacher_get_students_by_course.php?course_id=${courseId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentStudents = result.data;
                    displayStudents(result.data);
                } else {
                    showMessage('Ошибка фильтрации', 'error');
                }
            } catch (error) {
                console.error('Ошибка фильтрации:', error);
                showMessage('Ошибка фильтрации по курсу', 'error');
            }
        }

        // Модальные окна
        function showAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'block';
        }

        function showBulkAssignModal() {
            loadBulkAssignData();
            document.getElementById('bulkAssignModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Назначение курсов студенту
        function assignCourses(studentId, studentName) {
            document.getElementById('assignStudentId').value = studentId;
            document.getElementById('assignStudentName').textContent = studentName || 'Неизвестный студент';
            loadCoursesForAssignment(studentId);
            document.getElementById('assignCoursesModal').style.display = 'block';
        }

        // Загрузка курсов для назначения
        async function loadCoursesForAssignment(studentId) {
            showLoading('coursesCheckbox', 'Загрузка курсов...');
            
            try {
                const response = await fetch('handlers/teacher_get_courses.php');
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('coursesCheckbox');
                    container.innerHTML = result.data.map(course => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="course-${course.id}" value="${course.id}">
                            <label for="course-${course.id}">
                                <strong>${course.title}</strong>
                                <div style="font-size: 12px; color: #666;">${course.description || 'Описание отсутствует'}</div>
                            </label>
                        </div>
                    `).join('');
                    
                    // Загружаем уже назначенные курсы и отмечаем их
                    await loadStudentCourses(studentId);
                }
            } catch (error) {
                console.error('Ошибка загрузки курсов:', error);
                showError('coursesCheckbox', 'Ошибка загрузки курсов');
            }
        }

        // Загрузка курсов студента
        async function loadStudentCourses(studentId) {
            try {
                const response = await fetch(`handlers/teacher_get_student_courses.php?student_id=${studentId}`);
                const result = await response.json();
                
                if (result.success) {
                    result.data.forEach(course => {
                        const checkbox = document.getElementById(`course-${course.id}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки курсов студента:', error);
            }
        }

        // Загрузка данных для массового назначения
        async function loadBulkAssignData() {
            try {
                // Загружаем курсы
                const coursesResponse = await fetch('handlers/teacher_get_courses.php');
                const coursesResult = await coursesResponse.json();
                
                if (coursesResult.success) {
                    const courseSelect = document.getElementById('bulkCourseSelect');
                    courseSelect.innerHTML = coursesResult.data.map(course => 
                        `<option value="${course.id}">${course.title}</option>`
                    ).join('');
                }

                // Загружаем студентов для чекбоксов
                const studentsResponse = await fetch('handlers/teacher_get_students.php');
                const studentsResult = await studentsResponse.json();
                
                if (studentsResult.success) {
                    const container = document.getElementById('bulkStudentsCheckbox');
                    container.innerHTML = studentsResult.data.map(student => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-student-${student.id}" value="${student.id}">
                            <label for="bulk-student-${student.id}">
                                ${student.first_name || 'Не указано'} ${student.last_name || ''} (${student.login})
                                ${student.student_group ? `<div style="font-size: 11px; color: #667eea;">${student.student_group}</div>` : ''}
                            </label>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
            }
        }

        // Загрузка контента для вкладки назначений
        async function loadAssignmentsContent() {
            showLoading('assignmentsContent', 'Загрузка данных...');
            
            try {
                const response = await fetch('handlers/teacher_get_assignments_data.php');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data.stats;
                    document.getElementById('assignmentsContent').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #667eea;">${stats.total_students}</div>
                                <div style="color: #666;">Всего студентов</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #28a745;">${stats.total_courses}</div>
                                <div style="color: #666;">Активных курсов</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #ffc107;">${stats.total_assignments}</div>
                                <div style="color: #666;">Назначений</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #17a2b8;">${stats.assignment_rate}%</div>
                                <div style="color: #666;">Охват</div>
                            </div>
                        </div>
                        
                        <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border-left: 4px solid #007bff;">
                            <h4><i class="fas fa-lightbulb"></i> Советы по назначению курсов</h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Используйте массовое назначение для группы студентов</li>
                                <li>Назначайте курсы в соответствии с уровнем подготовки</li>
                                <li>Проверяйте прогресс студентов после назначения</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки данных назначений:', error);
                showError('assignmentsContent', 'Ошибка загрузки данных');
            }
        }

        // Загрузка данных прогресса
        async function loadProgressData() {
            try {
                const response = await fetch('handlers/teacher_get_progress.php');
                const result = await response.json();
                
                if (result.success) {
                    displayProgressData(result.data);
                } else {
                    showError('progressTable', 'Данные прогресса не найдены');
                }
            } catch (error) {
                console.error('Ошибка загрузки прогресса:', error);
                showError('progressTable', 'Ошибка загрузки данных');
            }
        }

        // Отображение данных прогресса
        function displayProgressData(progressData) {
            const tbody = document.getElementById('progressTable');
            
            if (progressData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
                            Нет данных о прогрессе студентов
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = progressData.map(item => `
                <tr>
                    <td>
                        <strong>${item.student_name}</strong><br>
                        <small style="color: #666;">${item.student_login}</small>
                    </td>
                    <td>${item.course_title}</td>
                    <td>${item.total_assignments}</td>
                    <td>${item.completed_assignments}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${item.progress}%"></div>
                        </div>
                        <small>${item.progress}%</small>
                    </td>
                    <td>
                        <strong>${item.average_score || 0}</strong>/100
                    </td>
                    <td>
                        <button class="btn-small btn-primary" onclick="viewDetailedProgress(${item.student_id}, ${item.course_id})">
                            <i class="fas fa-eye"></i> Детали
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ========== РАБОЧИЕ ФУНКЦИИ ==========

        // Назначение курсов студенту
        async function assignCoursesToStudent() {
            const studentId = document.getElementById('assignStudentId').value;
            const checkboxes = document.querySelectorAll('#coursesCheckbox input[type="checkbox"]:checked');
            const courseIds = Array.from(checkboxes).map(cb => cb.value);

            if (courseIds.length === 0) {
                showMessage('Выберите хотя бы один курс', 'error');
                return;
            }

            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Назначение...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('handlers/teacher_assign_courses.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        course_ids: courseIds
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeModal('assignCoursesModal');
                    loadStudents(); // Обновляем список студентов
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Ошибка при назначении курсов', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Массовое назначение курса
        async function bulkAssignCourse() {
            const courseId = document.getElementById('bulkCourseSelect').value;
            const checkboxes = document.querySelectorAll('#bulkStudentsCheckbox input[type="checkbox"]:checked');
            const studentIds = Array.from(checkboxes).map(cb => cb.value);

            if (!courseId) {
                showMessage('Выберите курс', 'error');
                return;
            }

            if (studentIds.length === 0) {
                showMessage('Выберите хотя бы одного студента', 'error');
                return;
            }

            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Назначение...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('handlers/teacher_bulk_assign.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        course_id: courseId,
                        student_ids: studentIds
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeModal('bulkAssignModal');
                    loadStudents(); // Обновляем список
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Ошибка при массовом назначении', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Удаление студента
        async function deleteStudent(studentId) {
            if (!confirm('Вы уверены, что хотите удалить этого студента? Все его данные будут потеряны.')) {
                return;
            }

            try {
                const response = await fetch('handlers/teacher_delete_student.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_id: studentId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Студент успешно удален', 'success');
                    loadStudents(); // Обновляем список
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Ошибка при удалении студента', 'error');
            }
        }

        // Просмотр прогресса студента
        function viewStudentProgress(studentId) {
            showMessage('Просмотр прогресса студента в разработке', 'error');
            // window.location.href = `student_progress.html?student_id=${studentId}`;
        }

        // Детальный просмотр прогресса
        function viewDetailedProgress(studentId, courseId) {
            showMessage('Детальный просмотр прогресса в разработке', 'error');
            // window.location.href = `student_progress.html?student_id=${studentId}&course_id=${courseId}`;
        }

        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========

        // Функция показа сообщений
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Показать загрузку
        function showLoading(containerId, text = 'Загрузка...') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <p>${text}</p>
                </div>
            `;
        }

        // Показать ошибку
        function showError(containerId, text = 'Ошибка загрузки') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h3>${text}</h3>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Попробовать снова
                    </button>
                </div>
            `;
        }

        // Навигация
        function goBack() {
            window.location.href = 'teacher_dashboard.html';
        }

        // Обработка формы добавления студента
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                login: document.getElementById('newStudentLogin').value,
                email: document.getElementById('newStudentEmail').value,
                password: document.getElementById('newStudentPassword').value,
                first_name: document.getElementById('newStudentFirstName').value,
                last_name: document.getElementById('newStudentLastName').value,
                student_group: document.getElementById('newStudentGroup').value
            };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('handlers/teacher_add_student.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Студент успешно добавлен!', 'success');
                    closeModal('addStudentModal');
                    document.getElementById('addStudentForm').reset();
                    loadStudents(); // Перезагружаем список студентов
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Ошибка при добавлении студента', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Закрытие модальных окон при клике вне их
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Загрузка курсов (для полноты)
        async function loadCourses() {
            try {
                const response = await fetch('handlers/teacher_get_courses.php');
                const result = await response.json();
                
                if (result.success) {
                    allCourses = result.data;
                }
            } catch (error) {
                console.error('Ошибка загрузки курсов:', error);
            }
        }
    </script>
</body>
</html>
